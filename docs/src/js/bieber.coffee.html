<!DOCTYPE html><html><head><title>bieber.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../src/js/bieber.coffee.html" class="source selected"><span class="base_path">src / js / </span><span class="file_name">bieber.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>bieber.coffee</h1><div class="filepath">src/js/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h3>Globals</h3>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p><code>setInterval</code> variable</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">bieberFeeder = </span><span class="mi">0</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Frequency of feed updates</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">feedSpeed = </span><span class="mi">5000</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>String IDs of current Bieber tweets</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">currentTweets = </span><span class="p">[]</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><h3>Generic AJAX GET request</h3>
</td><td class="code"><div class="highlight"><pre><span class="nv">request = </span><span class="nf">(url, callback) -&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Create a request object</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">req = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Specify the HTTP method, URL, and asynchronous flag</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">req</span><span class="p">.</span><span class="nx">open</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Add an event handler</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">req</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s">&#39;load&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If request was successful,
pass the content of the request to the callback</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">200</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;** REQUEST SUCCEEDED **&#39;</span><span class="p">)</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;something went wrong, check the request status&#39;</span>
  <span class="p">,</span> <span class="kc">false</span><span class="p">)</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Start the request (with no POST)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">req</span><span class="p">.</span><span class="nx">send</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><h3>Deduper</h3>

<p>Remove tweets that are already in <code>currentTweets</code> and
tweets that appear more than once in a single request</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">deduper = </span><span class="nf">(tweets) -&gt;</span>
  <span class="nv">batchIDs = </span><span class="p">[]</span>
  <span class="nv">deduped = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">tweet</span> <span class="k">in</span> <span class="nx">tweets</span>
    <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span> <span class="k">in</span> <span class="nx">currentTweets</span> <span class="k">then</span> <span class="nv">current = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">idstr</span> <span class="k">in</span> <span class="nx">batchIDs</span> <span class="k">then</span> <span class="nv">seen = </span><span class="kc">true</span>
    <span class="nx">unless</span> <span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span> <span class="k">in</span> <span class="nx">currentTweets</span> <span class="o">or</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span> <span class="k">in</span> <span class="nx">batchIDs</span><span class="p">)</span>
      <span class="nx">deduped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tweet</span><span class="p">)</span>
      <span class="nx">batchIDs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">deduped</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><h3>I can has JSON pls?</h3>
</td><td class="code"><div class="highlight"><pre><span class="nv">getTweets = </span><span class="nf">(callback) -&gt;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Make a request to my feed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">request</span> <span class="s">&#39;http://bieber.mattpatenaude.com/feed/wmayner&#39;</span><span class="p">,</span>
    <span class="nf">(tweetText) -&gt;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Parse as JSON, remove duplicates, and pass it
to the callback</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">callback</span><span class="p">(</span><span class="nx">deduper</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">tweetText</span><span class="p">)))</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><h3>Print-A-Tweet, any tweet</h3>

<p>Takes a tweet object and a display function, e.g.
<code>(tweetElement) -&gt; tweetElement.fadeIn()</code></p>
</td><td class="code"><div class="highlight"><pre><span class="nv">printTweet = </span><span class="nf">(tweet, display) -&gt;</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Push its ID</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">currentTweets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span><span class="p">)</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Toss the tweet data into the <code>li</code></p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">li = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">)</span>
  <span class="nv">li.className = </span><span class="s">&#39;tweet&#39;</span>
  <span class="nv">li.id = </span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Hide the new tweet initially, so it can fade in</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">li.style.display = </span><span class="s">&quot;none&quot;</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Construct the tweet element (anchorizing the text)</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">li.innerHTML = </span><span class="s">&quot;</span>
<span class="s">    &lt;img class=&#39;tweet-img&#39; src=</span><span class="si">#{</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">profile_image_url</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s">&gt;</span>
<span class="s">    &lt;div class=&#39;tweet-content&#39;&gt;</span>
<span class="s">      &lt;div class=&#39;tweet-header-row&#39;&gt;</span>
<span class="s">        &lt;div class=&#39;tweet-name&#39;&gt;</span>
<span class="s">          &lt;a href=&#39;http://www.twitter.com/</span><span class="si">#{</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">screen_name</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s">&#39; target=&#39;_blank&#39;&gt;</span>
<span class="s">            </span><span class="si">#{</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"></span>
<span class="s">          &lt;/a&gt;</span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">        &lt;div class=&#39;tweet-handle&#39;&gt;</span>
<span class="s">          @</span><span class="si">#{</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">screen_name</span> <span class="o">or</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"></span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">      &lt;/div&gt;</span>
<span class="s">      &lt;div class=&#39;tweet-text-wrapper&#39;&gt;</span>
<span class="s">        &lt;div class=&#39;tweet-text&#39;&gt;</span>
<span class="s">          </span><span class="si">#{</span><span class="nx">anchorize</span><span class="p">(</span><span class="nx">tweet</span><span class="p">)</span><span class="si">}</span><span class="s"></span>
<span class="s">        &lt;/div&gt;</span>
<span class="s">      &lt;/div&gt;</span>
<span class="s">    &lt;/div&gt;&quot;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Insert into it the feed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">newTweet = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#tweets&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">li</span><span class="p">,</span>
    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#tweets&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">firstChild</span><span class="p">)</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Display it using the passed function</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">display</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="o">+</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id_str</span><span class="p">))</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><h3>Display a full stack of lovely Bieber tweets (Beets)</h3>
</td><td class="code"><div class="highlight"><pre><span class="nv">populateFeed = </span><span class="nf">(callback) -&gt;</span>
  <span class="nx">getTweets</span> <span class="nf">(tweets) -&gt;</span>
    <span class="k">for</span> <span class="nx">tweet</span> <span class="k">in</span> <span class="nx">tweets</span>
      <span class="nx">printTweet</span><span class="p">(</span><span class="nx">tweet</span><span class="p">,</span>
        <span class="nf">(newTweet) -&gt;</span> <span class="nx">newTweet</span><span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="s">&quot;normal&quot;</span><span class="p">))</span>
    <span class="nx">callback</span><span class="o">?</span><span class="p">()</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><h3>Update the feed</h3>
</td><td class="code"><div class="highlight"><pre><span class="nv">updateFeed = </span><span class="nf">() -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;** UPDATING FEED **&quot;</span>
  <span class="nx">getTweets</span> <span class="nf">(tweets) -&gt;</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Print a tweet and remove the last one</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">printTweet</span><span class="p">(</span><span class="nx">tweets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nf">(newTweet) -&gt;</span> <span class="nx">newTweet</span><span class="p">.</span><span class="nx">slideDown</span><span class="p">(</span><span class="s">&quot;normal&quot;</span><span class="p">))</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Remove last tweet from DOM and <code>currentTweets</code></p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">lastTweet = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;.tweet&#39;</span><span class="p">).</span><span class="nx">last</span><span class="p">()</span>
    <span class="nx">lastTweet</span><span class="p">.</span><span class="nx">slideUp</span><span class="p">(</span><span class="s">&quot;normal&quot;</span><span class="p">,</span> <span class="nf">() -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">())</span>
    <span class="nx">currentTweets</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">currentTweets</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">lastTweet</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()),</span><span class="mi">1</span><span class="p">)</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><h3>Wait, please, make it stop...</h3>

<p>The event handler for the play/pause button.</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">feedControl = </span><span class="p">()</span> <span class="o">=&gt;</span>
  <span class="nv">control = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#control&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">control</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;playing&#39;</span><span class="p">)</span>
    <span class="nx">stopFeed</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;** PAUSE FEED **&quot;</span>
    <span class="nx">control</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;playing&#39;</span><span class="p">)</span>
    <span class="nx">control</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;paused&#39;</span><span class="p">)</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">control</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;paused&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Update feed immediately on click</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">updateFeed</span><span class="p">()</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>Start auto-updating</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">startFeed</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;** PLAY FEED **&quot;</span>
    <span class="nx">control</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;paused&#39;</span><span class="p">)</span>
    <span class="nx">control</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;playing&#39;</span><span class="p">)</span>

<span class="nv">startFeed = </span><span class="nf">() -&gt;</span>
  <span class="nv">bieberFeeder = </span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">updateFeed</span><span class="p">,</span> <span class="nx">feedSpeed</span><span class="p">)</span>

<span class="nv">stopFeed = </span><span class="nf">() -&gt;</span>
  <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">bieberFeeder</span><span class="p">)</span>
  <span class="nv">bieberFeeder = </span><span class="mi">0</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><h2>LIGHTS, CAMERA, BIEBERRRRRRRRR</h2>
</td><td class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s">&#39;document&#39;</span><span class="p">).</span><span class="nx">ready</span> <span class="nf">() -&gt;</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Hide everything initially</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#container, footer&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Fade-in everything after feed is populated</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">populateFeed</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#container, footer&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">1500</span><span class="p">))</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>Start feed</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">startFeed</span><span class="p">()</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Press <code>p</code> to play/pause</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">keydown</span> <span class="nf">(e) -&gt;</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">80</span>
      <span class="nx">feedControl</span><span class="p">()</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#control-info&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="s">&#39;normal&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>Add feed-control click handler</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#control&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">feedControl</span><span class="p">)</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><h3>Anchorize</h3>

<p>Put anchors in the tweet text based on tweet entities</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">anchorize = </span><span class="nf">(tweet) -&gt;</span>
  <span class="nv">text = </span><span class="nx">tweet</span><span class="p">.</span><span class="nx">text</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>Quote a string for regex escaping</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">quote = </span><span class="nf">(str) -&gt;</span>
    <span class="k">return</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([.*+?^=!:${}()|[\]\/\\])/g</span><span class="p">,</span> <span class="s">&quot;\\$1&quot;</span><span class="p">)</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Anchorize urls</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">urls</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">url</span> <span class="k">in</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">urls</span>
      <span class="nv">re = </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">url</span><span class="p">),</span> <span class="s">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">text = </span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span><span class="s">&#39;&lt;a href=&quot;&#39;</span><span class="o">+</span><span class="nx">url</span><span class="p">.</span><span class="nx">expanded_url</span><span class="o">+</span><span class="s">&#39;&quot; target=&quot;_blank&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">url</span><span class="p">.</span><span class="nx">display_url</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>Anchorize user mentions</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">user_mentions</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">userMention</span> <span class="k">in</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">user_mentions</span>
      <span class="nv">re = </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="o">+</span><span class="nx">userMention</span><span class="p">.</span><span class="nx">screen_name</span><span class="p">),</span> <span class="s">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">text = </span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span><span class="s">&#39;&lt;span class=screen-name&gt;@&lt;a href=&quot;http://twitter.com/&#39;</span><span class="o">+</span><span class="nx">userMention</span><span class="p">.</span><span class="nx">screen_name</span><span class="o">+</span><span class="s">&#39;&quot; target=&quot;_blank&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">userMention</span><span class="p">.</span><span class="nx">screen_name</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&lt;/span&gt;&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Anchorize media</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">media</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">media</span> <span class="k">in</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">media</span>
      <span class="nv">re = </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="nx">media</span><span class="p">.</span><span class="nx">url</span><span class="p">),</span> <span class="s">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">text = </span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span><span class="s">&#39;&lt;a href=&quot;&#39;</span><span class="o">+</span><span class="nx">media</span><span class="p">.</span><span class="nx">expanded_url</span><span class="o">+</span><span class="s">&#39;&quot; target=&quot;_blank&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">media</span><span class="p">.</span><span class="nx">display_url</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Anchorize hashtags</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">hashtags</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">hashtag</span> <span class="k">in</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">entities</span><span class="p">.</span><span class="nx">hashtags</span>
      <span class="nv">re = </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="o">+</span><span class="nx">hashtag</span><span class="p">.</span><span class="nx">text</span><span class="p">),</span> <span class="s">&#39;g&#39;</span><span class="p">)</span>
      <span class="nv">text = </span><span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span><span class="s">&#39;&lt;span class=hashtag&gt;#&lt;a href=&quot;http://twitter.com/search?q=%23&#39;</span><span class="o">+</span><span class="nx">hashtag</span><span class="p">.</span><span class="nx">text</span><span class="o">+</span><span class="s">&#39;&quot; target=&quot;_blank&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">hashtag</span><span class="p">.</span><span class="nx">text</span><span class="o">+</span><span class="s">&#39;&lt;/a&gt;&lt;/span&gt;&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>Anchorize and truncate any remaining links</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">re = </span><span class="sr">/(\b(https?|ftp|file):\/\/[-A-Z0-9+&amp;@#\/%?=~_|!:,.;]*[-A-Z0-9+&amp;@#\/%=~_|])/ig</span>
  <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(href) -&gt;</span>
    <span class="nv">partial = </span><span class="nx">href</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">10</span> <span class="o">?</span> <span class="nv">href : </span><span class="nx">href</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;...&quot;</span>
    <span class="k">return</span> <span class="s">&quot;&lt;a href=&#39;&quot;</span><span class="o">+</span><span class="nx">href</span><span class="o">+</span><span class="s">&quot;&#39; target=&#39;_blank&#39;&gt;&quot;</span><span class="o">+</span>
      <span class="nx">partial</span><span class="o">+</span><span class="s">&quot;&lt;/a&gt;&quot;</span>

  <span class="k">return</span> <span class="nx">text</span>

</pre></div></td></tr></tbody></table></div></body></html>